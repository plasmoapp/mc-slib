name: Build PR

on:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize
      - ready_for_review
  push:
    branches:
      - 'feat/**'
      - 'fix/**'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v5

      - name: Set up JDK
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: 21

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          cache-read-only: false

      - name: Setup Gradle loom cache
        uses: actions/cache@v5
        with:
          path: |
            **/loom-cache
          key: gradle-caches-${{ hashFiles('**/*.gradle*') }}-${{ hashFiles('**/gradle.properties', 'gradle/*.versions.toml') }}
          restore-keys: |
            gradle-caches-${{ hashFiles('**/*.gradle*') }}
            gradle-caches-

      - name: Build with Gradle
        run: ./gradlew build -Pmodded.versions_mode=ALL

  smoke-tests-modded:
    strategy:
      matrix:
        version:
          - 1.16.5-fabric
          - 1.16.5-forge
          - 1.19.3-fabric
          - 1.19.3-forge
          - 1.20.1-fabric
          - 1.20.1-forge
          - 1.21-fabric
          - 1.21-forge
          - 1.21-neoforge
          - 1.21.6-fabric
          - 1.21.6-neoforge
          - 1.21.7-neoforge
          - 1.21.9-fabric
          - 1.21.9-neoforge
          - 1.21.11-fabric
          - 1.21.11-neoforge
    runs-on: ubuntu-latest
    needs: build

    steps:
      - uses: actions/checkout@v5

      - name: Set up JDK
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: 21

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          cache-read-only: false

      - name: Setup Gradle loom cache
        uses: actions/cache@v5
        with:
          path: |
            **/loom-cache
          key: gradle-caches-${{ hashFiles('**/*.gradle*') }}-${{ hashFiles('**/gradle.properties', 'gradle/*.versions.toml') }}
          restore-keys: |
            gradle-caches-${{ hashFiles('**/*.gradle*') }}
            gradle-caches-

      - name: Run smoke test
        run: ./scripts/smoke-test-server.sh modded:${{ matrix.version }}:runServer -Pmodded.versions_dev=${{ matrix.version }}

  smoke-tests-paper:
    strategy:
      matrix:
        version:
          - 1.16.5
          - 1.19.2
          - 1.19.4
          - 1.20.1
          - 1.21.1
          - 1.21.8
          - 1.21.11
    runs-on: ubuntu-latest
    needs: build

    steps:
      - uses: actions/checkout@v5

      - name: Set up JDK
        uses: actions/setup-java@v5
        with:
          distribution: temurin
          java-version: 21

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5
        with:
          cache-read-only: false

      - name: Setup Gradle loom cache
        uses: actions/cache@v5
        with:
          path: |
            **/loom-cache
          key: gradle-caches-${{ hashFiles('**/*.gradle*') }}-${{ hashFiles('**/gradle.properties', 'gradle/*.versions.toml') }}
          restore-keys: |
            gradle-caches-${{ hashFiles('**/*.gradle*') }}
            gradle-caches-

      - name: Run smoke test
        run: ./scripts/smoke-test-server.sh spigot:runServer -Pspigot.run_minecraft_version=${{ matrix.version }}
